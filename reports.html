<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health Reports - AsthmaCare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://use.typekit.net/yjp3aho.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: "sofia-pro", sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Navigation -->
  <div id="navbar-container" data-source="components/navbar.html"></div>

  <!-- Header Section -->
  <section class="gradient-bg text-white pt-20 pb-16" data-id="header-section">
    <div class="container mx-auto px-4">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-4xl lg:text-5xl font-bold mb-6" data-id="page-title">
          Health Reports & Documents
        </h1>
        <p class="text-xl opacity-90" data-id="page-subtitle">
          Securely store and manage your medical documents, prescriptions, and test results
        </p>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-16" data-id="main-content">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        <div class="grid lg:grid-cols-3 gap-8">
          
          <!-- Upload Section -->
          <div class="lg:col-span-1">
            <div class="bg-white rounded-2xl shadow-lg p-8 sticky top-8" data-id="upload-section">
              <h2 class="text-2xl font-bold text-gray-800 mb-6" data-id="upload-title">
                Upload New Document
              </h2>
              
              <!-- File Upload Area -->
              <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-400 transition-colors cursor-pointer" data-id="upload-area">
                <div class="mb-4">
                  <i data-lucide="cloud-upload" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                  <p class="text-gray-600 font-medium mb-2">Drop files here or click to browse</p>
                  <p class="text-sm text-gray-500">Supports PDF, JPG, PNG up to 10MB</p>
                </div>
                <input type="file" id="file-input" class="hidden" accept=".pdf,.jpg,.jpeg,.png" multiple data-id="file-input">
              </div>

              <!-- Document Type Selection -->
              <div class="mt-6" data-id="document-type-section">
                <label for="document-type" class="block text-sm font-medium text-gray-700 mb-2">Document Type</label>
                <select id="document-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-id="document-type-select">
                  <option value="">Select document type</option>
                  <option value="prescription">Prescription</option>
                  <option value="test-result">Test Result</option>
                  <option value="medical-report">Medical Report</option>
                  <option value="insurance">Insurance Document</option>
                  <option value="x-ray">X-Ray/Imaging</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <!-- Document Notes -->
              <div class="mt-6" data-id="notes-section">
                <label for="document-notes" class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                <textarea id="document-notes" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" placeholder="Add any notes about this document..." data-id="document-notes"></textarea>
              </div>

              <!-- Upload Progress -->
              <div id="upload-progress" class="mt-6 hidden" data-id="upload-progress">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-medium text-gray-700">Uploading...</span>
                  <span id="progress-percentage" class="text-sm text-gray-500">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300 w-0"></div>
                </div>
              </div>

              <!-- Upload Button -->
              <button id="upload-btn" class="w-full mt-6 bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-50" disabled data-id="upload-btn">
                <span id="upload-btn-text">Upload Documents</span>
                <div id="upload-spinner" class="hidden">
                  <i data-lucide="loader-2" class="w-5 h-5 animate-spin mx-auto"></i>
                </div>
              </button>
            </div>
          </div>

          <!-- Documents List -->
          <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl shadow-lg" data-id="documents-section">
              <!-- Header -->
              <div class="p-8 border-b border-gray-200" data-id="documents-header">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                  <h2 class="text-2xl font-bold text-gray-800">Your Documents</h2>
                  
                  <!-- Search and Filter -->
                  <div class="flex flex-col sm:flex-row gap-3">
                    <div class="relative">
                      <input type="text" id="search-documents" placeholder="Search documents..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-id="search-input">
                      <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    </div>
                    <select id="filter-type" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-id="filter-select">
                      <option value="">All Types</option>
                      <option value="prescription">Prescriptions</option>
                      <option value="test-result">Test Results</option>
                      <option value="medical-report">Medical Reports</option>
                      <option value="insurance">Insurance</option>
                      <option value="x-ray">X-Ray/Imaging</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Documents Grid -->
              <div class="p-8" data-id="documents-grid">
                <div id="documents-container" class="grid md:grid-cols-2 gap-6" data-id="documents-container">
                  <!-- Documents will be loaded here -->
                  <div class="text-center py-12 md:col-span-2" id="empty-state" data-id="empty-state">
                    <i data-lucide="file-text" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                    <p class="text-gray-500 text-lg font-medium mb-2">No documents uploaded yet</p>
                    <p class="text-gray-400">Upload your first document to get started</p>
                  </div>
                </div>

                <!-- Loading State -->
                <div id="loading-documents" class="hidden text-center py-12" data-id="loading-documents">
                  <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>
                  <p class="text-gray-500">Loading your documents...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Document Preview Modal -->
  <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" data-id="preview-modal">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden" data-runtime="true">
      <div class="flex items-center justify-between p-6 border-b">
        <h3 id="modal-title" class="text-xl font-bold text-gray-800">Document Preview</h3>
        <button id="close-modal" class="text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div class="p-6 max-h-[70vh] overflow-auto">
        <div id="modal-content" class="text-center">
          <!-- Content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-container" data-source="components/footer.html"></div>

  <!-- Badge -->
  <div id="badge-container" data-source="components/badge.html"></div>

  <!-- Scripts -->
  <script type="module">
    import { loadComponent } from './scripts/components/loader.js';
    import { AuthManager } from './scripts/auth/auth.js';
    import { uploadHealthReport, getHealthReports, deleteHealthReport } from './scripts/utils/api.js';

    // Initialize components
    await loadComponent('#navbar-container');
    await loadComponent('#footer-container');
    await loadComponent('#badge-container');

    // Initialize auth
    const auth = new AuthManager();
    
    // Initialize icons
    lucide.createIcons();

    // Check authentication
    auth.onAuthStateChange((user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      loadDocuments();
    });

    // DOM elements
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const documentType = document.getElementById('document-type');
    const documentNotes = document.getElementById('document-notes');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadBtnText = document.getElementById('upload-btn-text');
    const uploadSpinner = document.getElementById('upload-spinner');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const documentsContainer = document.getElementById('documents-container');
    const emptyState = document.getElementById('empty-state');
    const loadingDocuments = document.getElementById('loading-documents');
    const searchInput = document.getElementById('search-documents');
    const filterSelect = document.getElementById('filter-type');
    const previewModal = document.getElementById('preview-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    const closeModal = document.getElementById('close-modal');

    let selectedFiles = [];
    let allDocuments = [];

    // File upload handling
    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('border-blue-400', 'bg-blue-50');
    });

    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      selectedFiles = Array.from(files).filter(file => {
        const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (!validTypes.includes(file.type)) {
          alert(`${file.name} is not a supported file type`);
          return false;
        }
        
        if (file.size > maxSize) {
          alert(`${file.name} is too large. Maximum size is 10MB`);
          return false;
        }
        
        return true;
      });

      updateUploadArea();
      uploadBtn.disabled = selectedFiles.length === 0;
    }

    function updateUploadArea() {
      if (selectedFiles.length > 0) {
        uploadArea.innerHTML = `
          <div class="mb-4">
            <i data-lucide="check-circle" class="w-12 h-12 text-green-500 mx-auto mb-4"></i>
            <p class="text-gray-600 font-medium mb-2">${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''} selected</p>
            <div class="space-y-1">
              ${selectedFiles.map(file => `
                <p class="text-sm text-gray-500">${file.name}</p>
              `).join('')}
            </div>
          </div>
        `;
        lucide.createIcons();
      }
    }

    // Upload documents
    uploadBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;

      const type = documentType.value;
      const notes = documentNotes.value;

      if (!type) {
        alert('Please select a document type');
        return;
      }

      setUploadLoading(true);

      try {
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          updateProgress((i / selectedFiles.length) * 100);

          await uploadHealthReport(file, {
            type: type,
            notes: notes,
            filename: file.name
          });
        }

        updateProgress(100);
        
        // Reset form
        selectedFiles = [];
        fileInput.value = '';
        documentType.value = '';
        documentNotes.value = '';
        uploadArea.innerHTML = `
          <div class="mb-4">
            <i data-lucide="cloud-upload" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
            <p class="text-gray-600 font-medium mb-2">Drop files here or click to browse</p>
            <p class="text-sm text-gray-500">Supports PDF, JPG, PNG up to 10MB</p>
          </div>
        `;
        lucide.createIcons();
        uploadBtn.disabled = true;

        // Refresh documents list
        await loadDocuments();
        
        alert('Documents uploaded successfully!');

      } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to upload documents. Please try again.');
      } finally {
        setUploadLoading(false);
        hideProgress();
      }
    });

    function setUploadLoading(loading) {
      uploadBtn.disabled = loading;
      uploadBtnText.classList.toggle('hidden', loading);
      uploadSpinner.classList.toggle('hidden', !loading);
    }

    function updateProgress(percentage) {
      uploadProgress.classList.remove('hidden');
      progressBar.style.width = `${percentage}%`;
      progressPercentage.textContent = `${Math.round(percentage)}%`;
    }

    function hideProgress() {
      uploadProgress.classList.add('hidden');
      progressBar.style.width = '0%';
      progressPercentage.textContent = '0%';
    }

    // Load documents
    async function loadDocuments() {
      showLoadingState();
      
      try {
        const documents = await getHealthReports();
        allDocuments = documents;
        renderDocuments(documents);
      } catch (error) {
        console.error('Error loading documents:', error);
        hideLoadingState();
        showEmptyState();
      }
    }

    function showLoadingState() {
      loadingDocuments.classList.remove('hidden');
      emptyState.classList.add('hidden');
      documentsContainer.innerHTML = '';
    }

    function hideLoadingState() {
      loadingDocuments.classList.add('hidden');
    }

    function showEmptyState() {
      emptyState.classList.remove('hidden');
    }

    function hideEmptyState() {
      emptyState.classList.add('hidden');
    }

    // Render documents
    function renderDocuments(documents) {
      hideLoadingState();
      
      if (documents.length === 0) {
        showEmptyState();
        return;
      }

      hideEmptyState();
      
      documentsContainer.innerHTML = documents.map(doc => `
        <div class="border border-gray-200 rounded-xl p-6 hover:shadow-md transition-shadow" data-runtime="true">
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <h3 class="font-semibold text-gray-800 mb-1">${doc.filename || 'Untitled Document'}</h3>
              <div class="flex items-center gap-2 mb-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTypeColor(doc.type)}">
                  ${getTypeLabel(doc.type)}
                </span>
                <span class="text-sm text-gray-500">${formatDate(doc.created_at)}</span>
              </div>
              ${doc.notes ? `<p class="text-sm text-gray-600">${doc.notes}</p>` : ''}
            </div>
            <div class="flex items-center gap-2">
              <button onclick="previewDocument('${doc.id}', '${doc.filename}', '${doc.file_url}')" class="text-blue-600 hover:text-blue-800 p-2">
                <i data-lucide="eye" class="w-4 h-4"></i>
              </button>
              <button onclick="downloadDocument('${doc.file_url}', '${doc.filename}')" class="text-green-600 hover:text-green-800 p-2">
                <i data-lucide="download" class="w-4 h-4"></i>
              </button>
              <button onclick="deleteDocument('${doc.id}')" class="text-red-600 hover:text-red-800 p-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 flex items-center">
            <div class="bg-white rounded-lg p-3 mr-4">
              <i data-lucide="${getFileIcon(doc.filename)}" class="w-6 h-6 text-gray-600"></i>
            </div>
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-700">${doc.filename}</p>
              <p class="text-xs text-gray-500">${getFileSize(doc.file_size)}</p>
            </div>
          </div>
        </div>
      `).join('');
      
      lucide.createIcons();
    }

    // Utility functions
    function getTypeColor(type) {
      const colors = {
        'prescription': 'bg-blue-100 text-blue-800',
        'test-result': 'bg-green-100 text-green-800',
        'medical-report': 'bg-purple-100 text-purple-800',
        'insurance': 'bg-orange-100 text-orange-800',
        'x-ray': 'bg-gray-100 text-gray-800',
        'other': 'bg-gray-100 text-gray-800'
      };
      return colors[type] || colors.other;
    }

    function getTypeLabel(type) {
      const labels = {
        'prescription': 'Prescription',
        'test-result': 'Test Result',
        'medical-report': 'Medical Report',
        'insurance': 'Insurance',
        'x-ray': 'X-Ray/Imaging',
        'other': 'Other'
      };
      return labels[type] || 'Other';
    }

    function getFileIcon(filename) {
      const ext = filename.toLowerCase().split('.').pop();
      if (ext === 'pdf') return 'file-text';
      if (['jpg', 'jpeg', 'png'].includes(ext)) return 'image';
      return 'file';
    }

    function getFileSize(bytes) {
      if (!bytes) return 'Unknown';
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // Global functions for document actions
    window.previewDocument = function(id, filename, url) {
      modalTitle.textContent = filename;
      
      const ext = filename.toLowerCase().split('.').pop();
      if (ext === 'pdf') {
        modalContent.innerHTML = `<iframe src="${url}" class="w-full h-96 border-0 rounded-lg"></iframe>`;
      } else if (['jpg', 'jpeg', 'png'].includes(ext)) {
        modalContent.innerHTML = `<img src="${url}" alt="${filename}" class="max-w-full h-auto rounded-lg">`;
      } else {
        modalContent.innerHTML = `<p class="text-gray-500">Preview not available for this file type</p>`;
      }
      
      previewModal.classList.remove('hidden');
      previewModal.classList.add('flex');
    };

    window.downloadDocument = function(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    window.deleteDocument = async function(id) {
      if (!confirm('Are you sure you want to delete this document?')) return;
      
      try {
        await deleteHealthReport(id);
        await loadDocuments();
        alert('Document deleted successfully');
      } catch (error) {
        console.error('Delete error:', error);
        alert('Failed to delete document');
      }
    };

    // Modal close handlers
    closeModal.addEventListener('click', () => {
      previewModal.classList.add('hidden');
      previewModal.classList.remove('flex');
    });

    previewModal.addEventListener('click', (e) => {
      if (e.target === previewModal) {
        previewModal.classList.add('hidden');
        previewModal.classList.remove('flex');
      }
    });

    // Search and filter
    searchInput.addEventListener('input', filterDocuments);
    filterSelect.addEventListener('change', filterDocuments);

    function filterDocuments() {
      const searchTerm = searchInput.value.toLowerCase();
      const filterType = filterSelect.value;

      const filteredDocuments = allDocuments.filter(doc => {
        const matchesSearch = !searchTerm || 
          doc.filename.toLowerCase().includes(searchTerm) ||
          (doc.notes && doc.notes.toLowerCase().includes(searchTerm));
        
        const matchesType = !filterType || doc.type === filterType;

        return matchesSearch && matchesType;
      });

      renderDocuments(filteredDocuments);
    }
  </script>
</body>
</html>